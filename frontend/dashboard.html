<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="logo">Bookshop</div>
        <div class="header-actions">
            <img id="profile-icon" class="profile-icon" alt="Profile"/>
        </div>
    </header>

    <main>
        <h1>Welcome to Your Dashboard</h1>
        <section id="books-section">
            <h2>Available Books</h2>
            <ul id="books-list"></ul>
        </section>
    </main>
    
    <div id="profile-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <div class="profile-header">
                    <div class="avatar-container">
                        <img id="modal-avatar" class="avatar-placeholder" alt="Profile Picture"/>
                        <div class="edit-avatar-icon">âœŽ</div>
                    </div>
                    <div class="user-text">
                        <h4 id="profile-name-header"></h4>
                        <p id="profile-email-header"></p>
                    </div>
                </div>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="detail-item">
                    <span>First Name</span>
                    <strong id="profile-firstName"></strong>
                </div>
                <div class="detail-item">
                    <span>Last Name</span>
                    <strong id="profile-lastName"></strong>
                </div>
                 <div class="detail-item">
                    <span>Password Hint</span>
                    <strong id="profile-passwordHint"></strong>
                </div>
            </div>
            <div class="modal-footer">
                <button id="logout-button" class="btn btn-danger">Logout</button>
                <button id="edit-profile-btn" class="btn btn-secondary">Edit</button>
            </div>
        </div>
    </div>

    <div id="users-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3>Manage Users</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body"><ul id="users-list"></ul></div>
        </div>
    </div>

    <div id="crop-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3>Update Profile Picture</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="crop-container"><img id="image-to-crop" src=""></div>
            </div>
            <div class="modal-footer">
                <button id="cancel-crop-btn" class="btn btn-secondary">Cancel</button>
                <button id="upload-btn" class="btn btn-primary">Crop & Upload</button>
            </div>
        </div>
    </div>

    <input type="file" id="image-input" class="hidden" accept="image/*">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const token = localStorage.getItem('token');
        if (!token) { window.location.href = 'index.html'; return; }

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) { return null; }
        }
        
        const currentUser = parseJwt(token)?.user;
        if (!currentUser) {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
            return;
        }
        
        // --- Element Selectors ---
        const profileIcon = document.getElementById('profile-icon');
        const modalAvatar = document.getElementById('modal-avatar');
        const profileModal = document.getElementById('profile-modal');
        const usersModal = document.getElementById('users-modal');
        const cropModal = document.getElementById('crop-modal');
        const imageInput = document.getElementById('image-input');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        let cropper;
        let isEditMode = false;

        // --- Generic Modal Close Logic ---
        document.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', () => btn.closest('.modal-overlay').classList.add('hidden'));
        });

        // --- Event Listeners ---
        profileIcon.addEventListener('click', () => profileModal.classList.remove('hidden'));

        document.getElementById('logout-button').addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        });

        // --- Fetch and Display Current User Data ---
        async function fetchAndDisplayCurrentUser() {
            try {
                const res = await fetch('/api/profile/me', { headers: { 'Authorization': `Bearer ${token}` } });
                const user = await res.json();
                
                document.getElementById('profile-name-header').textContent = `${user.firstName} ${user.lastName}`;
                document.getElementById('profile-email-header').textContent = user.email;
                document.getElementById('profile-firstName').textContent = user.firstName;
                document.getElementById('profile-lastName').textContent = user.lastName;
                document.getElementById('profile-passwordHint').textContent = user.passwordHint || 'Not Set';
                
                const placeholder = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
                const avatarSrc = user.profilePicture || placeholder;
                profileIcon.src = avatarSrc;
                modalAvatar.src = avatarSrc;
            } catch (error) { console.error("Failed to fetch user data:", error); }
        }
        fetchAndDisplayCurrentUser();

        // --- Edit Profile Details Logic ---
        editProfileBtn.addEventListener('click', async () => {
            isEditMode = !isEditMode;
            if (!isEditMode) { // Just clicked "Save"
                const newFirstName = document.getElementById('edit-firstName').value;
                const newLastName = document.getElementById('edit-lastName').value;
                try {
                    await fetch('/api/profile/details', { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ firstName: newFirstName, lastName: newLastName }) });
                } catch(err) { alert('Failed to save profile.'); }
            }
            toggleProfileEditUI(isEditMode);
        });

        function toggleProfileEditUI(isEditing) {
            const fNameEl = document.getElementById('profile-firstName');
            const lNameEl = document.getElementById('profile-lastName');
            editProfileBtn.textContent = isEditing ? 'Save' : 'Edit';

            function toInput(el, id) { el.outerHTML = `<input type="text" id="${id}" value="${el.textContent}" />`; }
            function toStrong(el, id) { el.outerHTML = `<strong id="${id}">${el.value}</strong>`; }

            if (isEditing) {
                toInput(fNameEl, 'edit-firstName');
                toInput(lNameEl, 'edit-lastName');
            } else {
                toStrong(document.getElementById('edit-firstName'), 'profile-firstName');
                toStrong(document.getElementById('edit-lastName'), 'profile-lastName');
                fetchAndDisplayCurrentUser(); // Refresh UI with saved data
            }
        }
        
        // --- Image Upload Logic ---
        document.querySelector('.avatar-container').addEventListener('click', () => imageInput.click());

        imageInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = () => {
                    const imageToCrop = document.getElementById('image-to-crop');
                    imageToCrop.src = reader.result;
                    cropModal.classList.remove('hidden');
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(imageToCrop, { aspectRatio: 1, viewMode: 1 });
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        document.getElementById('cancel-crop-btn').addEventListener('click', () => cropModal.classList.add('hidden'));

        document.getElementById('upload-btn').addEventListener('click', async () => {
            if (cropper) {
                const canvas = cropper.getCroppedCanvas({ width: 256, height: 256 });
                const imageData = canvas.toDataURL('image/jpeg');
                try {
                    await fetch('/api/profile/picture', { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ imageData }) });
                    fetchAndDisplayCurrentUser();
                    cropModal.classList.add('hidden');
                } catch(err) { alert('Upload failed.'); }
            }
        });

        // --- Admin-Only Features ---
        if (currentUser.role === 'Admin') {
            const headerActions = document.querySelector('.header-actions');
            const mainContent = document.querySelector('main');

            const manageUsersBtn = document.createElement('button');
            manageUsersBtn.id = 'manage-users-btn';
            manageUsersBtn.className = 'btn btn-primary';
            manageUsersBtn.textContent = 'Manage Users';
            headerActions.insertBefore(manageUsersBtn, profileIcon);
            manageUsersBtn.addEventListener('click', loadAndShowAllUsers);
            
            const addBookForm = document.createElement('div');
            addBookForm.innerHTML = `<form id="add-book-form"><h3>Add New Book</h3><input type="text" id="book-title" placeholder="Title" required /><input type="text" id="book-author" placeholder="Author" required /><button type="submit" class="btn btn-primary">Add Book</button></form>`;
            mainContent.appendChild(addBookForm);
            addBookForm.addEventListener('submit', handleAddBook);
        }

        async function loadAndShowAllUsers() { /* ... unchanged ... */ }
        function createUserListItem(user) { /* ... unchanged ... */ }
        async function handleRoleChange(userId, role) { /* ... unchanged ... */ }
        async function handleDeleteUser(userId) { /* ... unchanged ... */ }
        async function handleAddBook(e) { /* ... unchanged ... */ }
        async function loadBooks() { /* ... unchanged ... */ }
        loadBooks();
    });
    </script>
</body>
</html>